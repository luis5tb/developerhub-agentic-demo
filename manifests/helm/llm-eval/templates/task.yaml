apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: lmeval-task
  namespace: {{ .Values.namespace }}
  labels:
    backstage.io/kubernetes-id: ${{values.component_id}}
spec:
  params:
    - name: job_name
      description: name of the lm eval job
      type: string
    - name: model
      description: name of the model to evaluate
      type: string
    - name: url
      description: model endpoint
      type: string
    - name: num_concurrent
      description: Concurrent requests
      type: string
    - name: max_retries
      description: Max retries
      type: string
    - name: tokenized_requests
      description: Tokenized requests
      type: string
    - name: tokenizer
      description: Tokenizer
      type: string
    - name: tasks_name
      type: array
      description: Eval Tasks to use (only set task_name or task_recipe)
      default: []
    - name: task_recipe
      description: Eval Recipe to use (only set task_name or task_recipe)
      type: object
      properties:
        card:
          type: object
          properties:
            name: {type: string}
            custom: {type: string}
        template: {type: string}
      default: {}
  steps:
    - name: run-lmeval
      image: {{ .Values.evalOptions.baseImage }}
      script: |
        cat <<EOF > /workspace/evaljob.yaml
        apiVersion: trustyai.opendatahub.io/v1alpha1
        kind: LMEvalJob
        metadata:
          name: $(params.job_name)
          namespace: {{ .Values.namespace}}
        spec:
          model: local-completions
          taskList:        
        EOF

        if [ ${#params.tasks_name[@]} -gt 0 ]; then
          echo "    taskNames:" >> /workspace/evaljob.yaml
          for task in $(params.tasks_name[*]); do
            echo "      - $task" >> /workspace/evaljob.yaml
          done
        elif [ -n "$(params.task_recipe.template)" ]; then
          echo "    taskRecipes:" >> /workspace/evaljob.yaml
          echo "    - template: $(params.taskrecipe.template)" >> /workspace/evaljob.yaml
          echo "      card:" >> /workspace/evaljob.yaml
          if [ -n "$(params.task_recipe.card.name)" ]; then           
            echo "        name: $(params.task_recipe.card.name)" >> /workspace/evaljob.yaml
          elif [ -n "$(params.task_recipe.card.custom)" ]; then
            echo "        custom: |" >> /workspace/evaljob.yaml
            echo "$(params.task_recipe.card.custom)" | sed 's/^/          /' >> /workspace/evaljob.yaml
          fi
        else
          echo "Error: Either tasks_names or task_recipe must be provided."
          exit 1
        fi

        cat <<EOF >> /workspace/evaljob.yaml
          logSamples: true
          batchSize: "1"
          allowOnline: true
          allowCodeExecution: true
          modelArgs:
            - name: model
              value: $(params.model)
            - name: base_url
              value: $(params.url)/v1/completions 
            - name: num_concurrent
              value: "$(params.num_concurrent)"
            - name: max_retries
              value: "$(params.max_retries)"
            - name: tokenized_requests
              value: "$(params.tokenized_requests)"
            - name: tokenizer
              value: $(params.tokenizer)
            - name: verify_certificate
              value: "{{ $.Values.evalOptions.verifyCertificate }}"
          pod: 
            container:
              env:
              - name: OPENAI_API_KEY 
                valueFrom:
                      secretKeyRef: 
                        name: {{ $.Values.saName }}-{{ $.Values.modelName }}-sa
                        key: token 
              resources:
                  limits: 
                    cpu: '1'
                    memory: 8Gi
                    nvidia.com/gpu: '1'
                  requests:
                    cpu: '1'
                    memory: 8Gi
                    nvidia.com/gpu: '1'
          outputs: 
            pvcManaged: 
              size: 5Gi 
        EOF

        oc create -f /workspace/evaljob.yaml

        # Wait for job completion
        oc wait -n {{ .Values.namespace }} --timeout=3600s --for=condition=complete lmevaljob/$(params.job_name)
  workspaces:
    - name: shared-data